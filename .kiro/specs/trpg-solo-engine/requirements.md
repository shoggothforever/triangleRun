# 需求文档

## 简介

本系统是一个基于《三角机构》TRPG规则的单人自助体验应用后端系统。系统使用Golang构建，旨在让个人玩家能够独自体验完整的跑团规则和剧本，通过自动化的规则解释、骰子判定和AI叙事引导，提供沉浸式的单人TRPG体验。

## 术语表

- **TRPG系统**: 基于《三角机构》规则的桌面角色扮演游戏后端系统
- **外勤特工**: 玩家扮演的角色，是与异常体绑定的共鸣者
- **ARC**: 角色构建的三要素（Anomaly异常、Reality现实、Career职能）
- **异常体**: 由思想创造的超自然存在，拥有焦点和领域
- **共鸣者**: 与异常体绑定并获得超自然力量的凡俗存在
- **规则引擎**: 负责解释和执行《三角机构》核心规则的组件
- **骰子系统**: 使用6d4判定系统，统计显示"3"的数量
- **资质保证QA**: 九种资质的保证点数，可用于调整骰子结果
- **混沌池**: 追踪异常能量的系统，异常体利用混沌对抗玩家
- **请求机构**: 玩家改变不久前过去的能力
- **异常能力**: 每个异常体类型拥有的3种获批能力
- **游戏会话**: 一次完整的任务执行过程
- **AI总经理**: 模拟GM角色，提供叙事、判定和NPC扮演

## 需求

### 需求 1

**用户故事:** 作为一个玩家，我想要创建和管理我的外勤特工角色，以便我可以在游戏中体验完整的ARC系统

#### 验收标准

1. WHEN 玩家选择异常体类型（低语、目录、汲取、时计、生长、枪械、梦境、流形、缺位），THEN TRPG系统 SHALL 创建角色并分配对应的3种异常能力
2. WHEN 玩家选择现实类型（看护者、日程过载、受追猎者、明星、挣扎求生、新生儿、浪漫主义、支柱、异类），THEN TRPG系统 SHALL 记录现实触发器、过载解除和人际关系
3. WHEN 玩家选择职能类型（公关、研发、咖啡师、CEO、实习生、掘墓人、接待处、热线、小丑），THEN TRPG系统 SHALL 分配初始资质保证QA点数和许可行为
4. WHEN 玩家创建人际关系，THEN TRPG系统 SHALL 记录3段人际关系及其连结点数（总计12点）
5. WHEN 玩家请求查看角色信息，THEN TRPG系统 SHALL 返回完整的ARC信息、资质保证、人际关系和当前状态

### 需求 2

**用户故事:** 作为一个玩家，我想要系统能够正确执行6d4骰子判定系统，以便游戏体验符合《三角机构》规则

#### 验收标准

1. WHEN 玩家使用异常能力或请求机构，THEN 骰子系统 SHALL 投掷6颗四面骰并统计显示"3"的数量
2. WHEN 骰子结果至少有一个"3"，THEN 骰子系统 SHALL 判定为成功并应用成功效果
3. WHEN 骰子结果没有"3"，THEN 骰子系统 SHALL 判定为失败并应用失败效果，同时每颗非"3"骰子产生1点混沌
4. WHEN 骰子结果恰好为三个"3"（调整前），THEN 骰子系统 SHALL 触发三重升华效果且不产生混沌
5. WHEN 玩家花费资质保证QA，THEN 骰子系统 SHALL 允许将任意骰子调整为"3"或从"3"调整为其他数字

### 需求 3

**用户故事:** 作为一个玩家，我想要体验完整的异常体回收任务流程，以便享受沉浸式的《三角机构》游戏体验

#### 验收标准

1. WHEN 玩家开始新任务，THEN 任务系统 SHALL 生成包含晨会、调查和遭遇三个阶段的任务流程
2. WHEN 玩家在调查阶段行动，THEN 任务系统 SHALL 追踪散逸端数量并根据线索引导玩家找到异常体领域
3. WHEN 玩家进入异常体领域，THEN 任务系统 SHALL 触发遭遇阶段并激活异常体的混沌效应
4. WHEN 玩家成功捕获异常体，THEN 任务系统 SHALL 为所有特工授予3次嘉奖并记录任务结果为"已捕获"
5. WHEN 任务结束，THEN 任务系统 SHALL 生成任务报告，包含异常体状态、散逸端数量、焦点和领域信息

### 需求 4

**用户故事:** 作为一个玩家，我想要系统正确管理资质保证和过载机制，以便我可以策略性地使用资源

#### 验收标准

1. WHEN 玩家创建角色，THEN 资质系统 SHALL 根据职能分配9点资质保证到9种资质（专注、共情、气场、欺瞒、主动、专业、活力、坚毅、诡秘）
2. WHEN 玩家在某资质上无剩余QA时掷骰，THEN 资质系统 SHALL 应用过载效果，移除一个"3"并产生1点混沌
3. WHEN 玩家触发过载解除条件，THEN 资质系统 SHALL 在该次掷骰中无视所有过载效果
4. WHEN 任务间隙到来，THEN 资质系统 SHALL 将所有资质保证充能至当前上限
5. WHEN 玩家花费资质保证，THEN 资质系统 SHALL 从对应资质中扣除点数并允许调整骰子结果

### 需求 5

**用户故事:** 作为一个玩家，我想要系统正确处理混沌池和异常体效应，以便体验紧张刺激的对抗

#### 验收标准

1. WHEN 玩家掷骰失败，THEN 混沌系统 SHALL 为每颗非"3"骰子向混沌池添加1点混沌
2. WHEN 异常体使用混沌效应，THEN 混沌系统 SHALL 从混沌池中扣除相应点数并应用效应
3. WHEN 任务开始，THEN 混沌系统 SHALL 根据累积的散逸端数量初始化混沌池
4. WHEN 任务结束，THEN 混沌系统 SHALL 清空混沌池中所有未使用的混沌
5. WHEN 玩家在当前地点请求机构失败，THEN 混沌系统 SHALL 为该地点后续的现实变更请求添加1点过载

### 需求 6

**用户故事:** 作为一个玩家，我想要系统正确处理请求机构机制，以便我可以改变过去的现实

#### 验收标准

1. WHEN 玩家提出现实变更请求，THEN 请求系统 SHALL 要求玩家提供既定效果、因果链、相关资质和掷骰
2. WHEN 请求机构成功，THEN 请求系统 SHALL 应用玩家描述的效果并将其确立为既定事实
3. WHEN 请求机构失败，THEN 请求系统 SHALL 应用GM描述的反向效果并为该地点后续请求添加1点过载
4. WHEN 玩家尝试改变已确立的事实，THEN 请求系统 SHALL 拒绝该请求并提示玩家只能改变未确立的事物
5. WHEN 玩家请求影响某人心智，THEN 请求系统 SHALL 要求因果链必须是外在的而非直接的心智控制

### 需求 7

**用户故事:** 作为一个玩家，我想要系统正确处理异常能力的使用，以便我可以发挥角色的独特力量

#### 验收标准

1. WHEN 玩家使用异常能力，THEN 能力系统 SHALL 验证触发条件是否满足并执行掷骰
2. WHEN 异常能力掷骰成功，THEN 能力系统 SHALL 应用该能力的"成功时"效果
3. WHEN 异常能力掷骰失败，THEN 能力系统 SHALL 应用该能力的"失败时"效果并产生混沌
4. WHEN 异常能力掷骰结果满足额外条件（如"每额外一个3"、"每第三个3"），THEN 能力系统 SHALL 应用对应的额外效果
5. WHEN 玩家在工作之外使用异常能力，THEN 能力系统 SHALL 为玩家记录1次申诫

### 需求 8

**用户故事:** 作为一个玩家，我想要系统正确处理伤害和人寿保险机制，以便我可以在危险中生存

#### 验收标准

1. WHEN 玩家受到伤害，THEN 伤害系统 SHALL 允许玩家花费等量资质保证来无视伤害效果
2. WHEN 玩家在无资质保证时受到伤害或选择不使用保险，THEN 伤害系统 SHALL 判定玩家死亡并扣除5次嘉奖
3. WHEN 玩家死亡后复活，THEN 伤害系统 SHALL 在分部休息室复活玩家并保留死亡前记忆
4. WHEN 伤害超过1点，THEN 伤害系统 SHALL 根据伤害点数产生对应数量的散逸端（如有目击者）
5. WHEN 玩家嘉奖为负数，THEN 伤害系统 SHALL 将玩家标记为嘉奖负债状态并激活鞋带倡议

### 需求 9

**用户故事:** 作为一个玩家，我想要系统正确管理嘉奖和申诫系统，以便追踪我的表现

#### 验收标准

1. WHEN 玩家完成嘉奖行为（捕获异常体、完成可选目标等），THEN 绩效系统 SHALL 增加玩家的嘉奖计数
2. WHEN 玩家违反规则（放任异常体逃脱、滥用波纹枪等），THEN 绩效系统 SHALL 增加玩家的申诫计数并更新机构评级
3. WHEN 玩家获得申诫，THEN 绩效系统 SHALL 根据申诫总数更新机构评级（0=评级良好，1=有待改进，10+=权限已撤销）
4. WHEN 玩家完成任务报告，THEN 绩效系统 SHALL 根据报告完成度授予0、3或6次嘉奖
5. WHEN 玩家嘉奖达到特定数量，THEN 绩效系统 SHALL 允许玩家购买申领物或获得MVP奖

### 需求 10

**用户故事:** 作为一个玩家，我想要与AI总经理互动，以便获得类似真实GM的游戏体验

#### 验收标准

1. WHEN 玩家进入新场景，THEN AI总经理 SHALL 生成符合《三角机构》风格的场景描述
2. WHEN 玩家与NPC互动，THEN AI总经理 SHALL 根据NPC设定和剧情上下文生成对话响应
3. WHEN 玩家行动需要判定，THEN AI总经理 SHALL 确定相关资质并要求玩家掷骰
4. WHEN 异常体需要使用混沌效应，THEN AI总经理 SHALL 根据异常体特性设计并应用混沌效应
5. WHEN 玩家提出规则问题，THEN AI总经理 SHALL 提供准确的《三角机构》规则解释

### 需求 11

**用户故事:** 作为一个玩家，我想要保存和加载游戏进度，以便我可以随时中断和继续游戏

#### 验收标准

1. WHEN 玩家请求保存游戏，THEN 存档系统 SHALL 序列化角色ARC、任务进度、混沌池、资质保证和人际关系到JSON格式
2. WHEN 玩家请求加载存档，THEN 存档系统 SHALL 反序列化存档数据并恢复完整的游戏状态
3. WHEN 存档数据损坏或版本不兼容，THEN 存档系统 SHALL 返回明确的错误信息并保护原始数据
4. WHEN 玩家查询存档列表，THEN 存档系统 SHALL 返回所有可用存档及其元数据（时间、任务名、角色名）
5. WHEN 玩家删除存档，THEN 存档系统 SHALL 从持久化存储中移除对应的存档数据

### 需求 12

**用户故事:** 作为一个玩家，我想要系统能够加载和执行剧本模组，以便我可以体验不同的异常体回收故事

#### 验收标准

1. WHEN 系统加载剧本模组，THEN 剧本系统 SHALL 解析模组的异常体档案、调查线索、场景、NPC和遭遇数据
2. WHEN 玩家进入调查阶段，THEN 剧本系统 SHALL 根据玩家行动和选择动态呈现对应的场景和线索
3. WHEN 玩家与NPC互动，THEN 剧本系统 SHALL 根据NPC设定提供对话选项并记录玩家获得的信息
4. WHEN 玩家触发特定条件，THEN 剧本系统 SHALL 激活对应的事件、混沌效应或场景转换
5. WHEN 玩家完成调查并进入遭遇，THEN 剧本系统 SHALL 根据玩家之前的选择和异常体状态生成最终对抗

### 需求 13

**用户故事:** 作为一个玩家，我想要系统能够管理剧本中的场景和地点，以便我可以在不同地点间探索和调查

#### 验收标准

1. WHEN 玩家进入新地点，THEN 场景系统 SHALL 加载该地点的描述、可交互对象、NPC和可用行动
2. WHEN 玩家在地点间移动，THEN 场景系统 SHALL 保存当前场景状态并加载目标场景
3. WHEN 玩家与场景中的对象互动，THEN 场景系统 SHALL 根据对象类型触发对应的效果（获得线索、触发事件等）
4. WHEN 场景状态发生变化（如异常体扩张），THEN 场景系统 SHALL 更新场景描述和可用行动
5. WHEN 玩家返回已访问过的场景，THEN 场景系统 SHALL 恢复该场景的当前状态而非初始状态

### 需求 14

**用户故事:** 作为一个玩家，我想要系统能够追踪调查线索和信息，以便我可以逐步揭开异常体的真相

#### 验收标准

1. WHEN 玩家获得新线索，THEN 线索系统 SHALL 将线索添加到玩家的调查日志并标记获取来源
2. WHEN 玩家查看线索，THEN 线索系统 SHALL 显示线索内容、相关NPC和可能的后续调查方向
3. WHEN 玩家收集到关键线索组合，THEN 线索系统 SHALL 自动解锁新的调查选项或场景
4. WHEN 玩家使用异常能力获取隐藏信息，THEN 线索系统 SHALL 标记该线索为"异常获取"并记录使用的能力
5. WHEN 玩家完成调查，THEN 线索系统 SHALL 生成调查报告，包含所有收集的线索和遗漏的关键信息

### 需求 15

**用户故事:** 作为一个玩家，我想要系统能够管理NPC的状态和关系，以便我可以与剧本中的角色互动

#### 验收标准

1. WHEN 玩家遇到NPC，THEN NPC系统 SHALL 加载NPC的基本信息、对话选项和当前状态
2. WHEN 玩家与NPC对话，THEN NPC系统 SHALL 根据NPC性格、玩家行为和剧情进度提供对应的对话内容
3. WHEN 玩家对NPC使用异常能力，THEN NPC系统 SHALL 更新NPC状态并可能触发特殊对话或事件
4. WHEN NPC被异常体影响，THEN NPC系统 SHALL 更新NPC行为模式并在对话中反映异常影响
5. WHEN 玩家行为影响NPC，THEN NPC系统 SHALL 记录关系变化并在后续互动中体现

### 需求 16

**用户故事:** 作为开发者，我想要系统提供RESTful API接口，以便前端或其他客户端可以与后端交互

#### 验收标准

1. WHEN 客户端发送API请求，THEN TRPG系统 SHALL 验证请求格式和认证信息
2. WHEN API操作成功，THEN TRPG系统 SHALL 返回标准化的JSON响应和适当的HTTP状态码
3. WHEN API操作失败，THEN TRPG系统 SHALL 返回包含错误代码和描述的错误响应
4. WHEN 并发请求访问同一游戏会话，THEN TRPG系统 SHALL 使用锁机制保证数据一致性
5. WHEN API文档需要生成，THEN TRPG系统 SHALL 提供OpenAPI/Swagger规范的接口文档
