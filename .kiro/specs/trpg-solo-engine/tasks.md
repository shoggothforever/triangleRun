# 实施计划

## 阶段1: 项目基础设施

- [x] 1. 初始化项目结构和核心依赖
  - 创建Go模块和目录结构（cmd, internal, pkg）
  - 配置Gin web框架
  - 设置Viper配置管理
  - 配置Zap日志系统
  - 创建Docker和docker-compose配置
  - _需求: 16.1, 16.2_

- [x] 2. 设置数据库和缓存
  - 创建PostgreSQL数据库schema（agents, game_sessions, saves表）
  - 实现数据库连接池和迁移工具
  - 配置Redis缓存连接
  - 创建数据库索引
  - _需求: 11.1, 16.4_

## 阶段2: 核心领域模型

- [x] 3. 实现角色领域模型
  - 创建Agent、Anomaly、Reality、Career结构体
  - 实现Relationship和DegradationTrack模型
  - 定义ARC类型常量和验证函数
  - _需求: 1.1, 1.2, 1.3_

- [x] 3.1 编写角色创建完整性属性测试
  - **属性1: 角色创建完整性**
  - **验证需求: 1.1, 1.2, 1.3, 1.4, 1.5**

- [x] 4. 实现游戏会话领域模型
  - 创建GameSession、GameState、GamePhase结构体
  - 实现NPCState和场景状态追踪
  - 定义会话生命周期方法
  - _需求: 3.1, 11.2_

- [x] 5. 实现剧本领域模型
  - 创建Scenario、Scene、AnomalyProfile结构体
  - 实现Clue、Event、NPC模型
  - 定义Focus、Domain、ChaosEffect结构体
  - _需求: 12.1, 12.2_

## 阶段3: 骰子和规则引擎

- [x] 6. 实现骰子系统
  - 创建DiceService接口和实现
  - 实现6d4掷骰逻辑
  - 实现成功/失败判定
  - 实现混沌生成逻辑
  - 实现三重升华检测
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 6.1 编写骰子判定一致性属性测试no
  - **属性2: 骰子判定一致性**
  - **验证需求: 2.1, 2.2, 2.3**

- [x] 6.2 编写三重升华零混沌属性测试no
  - **属性3: 三重升华零混沌**
  - **验证需求: 2.4**

- [x] 7. 实现资质保证系统
  - 创建QA管理服务
  - 实现QA花费和恢复逻辑
  - 实现过载机制
  - 实现过载解除检测
  - 实现骰子调整功能
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 2.5_

- [x] 7.1 编写资质保证不变量属性测试
  - **属性4: 资质保证不变量**
  - **验证需求: 4.1, 4.5**

- [x] 7.2 编写过载机制属性测试
  - **属性5: 过载机制**
  - **验证需求: 4.2, 4.3**

- [x] 7.3 编写任务间隙恢复属性测试
  - **属性6: 任务间隙恢复**
  - **验证需求: 4.4**

- [x] 8. 实现混沌系统
  - 创建ChaosService接口和实现
  - 实现混沌池管理
  - 实现混沌生成和消耗
  - 实现地点过载追踪
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 8.1 编写混沌守恒属性测试
  - **属性7: 混沌守恒**
  - **验证需求: 5.1, 5.2, 5.3, 5.4**

- [x] 8.2 编写请求机构地点过载属性测试
  - **属性8: 请求机构地点过载**
  - **验证需求: 5.5**

## 阶段4: 异常能力和请求机构

- [x] 9. 实现异常能力系统
  - 创建AbilityService接口和实现
  - 实现9种异常体的能力定义
  - 实现能力触发条件验证
  - 实现成功/失败效果应用
  - 实现额外效果计算
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9.1 编写异常能力效果一致性属性测试
  - **属性10: 异常能力效果一致性**
  - **验证需求: 7.2, 7.3, 7.4**

- [x] 10. 实现请求机构系统
  - 创建RequestService接口和实现
  - 实现现实变更请求验证
  - 实现因果链检查
  - 实现既定事实追踪
  - 实现心智控制检测
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 10.1 编写请求机构约束属性测试
  - **属性9: 请求机构约束**
  - **验证需求: 6.1, 6.4, 6.5**

## 阶段5: 伤害和绩效系统

- [x] 11. 实现伤害系统
  - 创建DamageService接口和实现
  - 实现人寿保险机制
  - 实现死亡和复活逻辑
  - 实现散逸端生成
  - 实现嘉奖负债检测
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 11.1 编写人寿保险机制属性测试
  - **属性11: 人寿保险机制**
  - **验证需求: 8.1, 8.2, 8.3**

- [x] 11.2 编写伤害与散逸端属性测试
  - **属性12: 伤害与散逸端**
  - **验证需求: 8.4**

- [x] 12. 实现绩效系统
  - 创建PerformanceService接口和实现
  - 实现嘉奖和申诫追踪
  - 实现机构评级计算
  - 实现任务奖励分配
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 3.4_

- [x] 12.1 编写机构评级映射属性测试
  - **属性13: 机构评级映射**
  - **验证需求: 9.3**

- [x] 12.2 编写任务结果奖励属性测试
  - **属性14: 任务结果奖励**
  - **验证需求: 3.4**

## 阶段6: 角色和会话服务

- [x] 13. 实现角色服务
  - 创建AgentService接口和实现
  - 实现角色CRUD操作
  - 实现ARC设置和验证
  - 实现人际关系管理
  - 实现资质保证操作
  - 实现绩效更新
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 13.1 编写角色服务单元测试
  - 测试角色创建和验证
  - 测试ARC组合的有效性
  - 测试人际关系管理
  - 测试资质保证操作

- [x] 14. 实现游戏会话服务
  - 创建GameService接口和实现
  - 实现会话CRUD操作
  - 实现阶段转换逻辑
  - 实现状态管理
  - 实现并发控制
  - _需求: 3.1, 3.2, 16.4_

- [x] 14.1 编写游戏会话单元测试
  - 测试会话创建和加载
  - 测试阶段转换
  - 测试状态更新
  - 测试并发访问

## 阶段7: 剧本和场景系统

- [x] 15. 实现剧本服务
  - 创建ScenarioService接口和实现
  - 实现剧本加载和解析
  - 实现剧本验证
  - 实现场景导航
  - 实现事件触发检测
  - _需求: 12.1, 12.2, 12.4, 12.5_

- [x] 15.1 编写剧本服务单元测试
  - 测试剧本加载
  - 测试剧本验证
  - 测试场景导航
  - 测试事件触发

- [x] 16. 实现场景系统
  - 创建SceneService接口和实现
  - 实现场景加载和状态管理
  - 实现场景对象交互
  - 实现场景状态持久化
  - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 16.1 编写场景状态持久化属性测试
  - **属性16: 场景状态持久化**
  - **验证需求: 13.2, 13.5**

- [x] 16.2 编写场景系统单元测试
  - 测试场景加载
  - 测试场景切换
  - 测试对象交互
  - 测试状态更新

## 阶段8: 线索和NPC系统

- [x] 17. 实现线索系统
  - 创建ClueService接口和实现
  - 实现线索追踪和存储
  - 实现线索解锁逻辑
  - 实现调查报告生成
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 17.1 编写线索解锁单调性属性测试
  - **属性17: 线索解锁单调性**
  - **验证需求: 14.1, 14.3**

- [x] 17.2 编写线索系统单元测试
  - 测试线索添加和查询
  - 测试线索解锁条件
  - 测试调查报告生成

- [x] 18. 实现NPC系统
  - 创建NPCService接口和实现
  - 实现NPC状态管理
  - 实现NPC关系追踪
  - 实现异常影响记录
  - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

- [x] 18.1 编写NPC状态一致性属性测试
  - **属性18: NPC状态一致性**
  - **验证需求: 15.3, 15.4**

- [x] 18.2 编写NPC系统单元测试
  - 测试NPC加载
  - 测试状态更新
  - 测试关系变化
  - 测试异常影响

## 阶段9: AI集成和游戏流程

- [x] 19. 实现AI服务
  - 创建AIService接口和实现
  - 实现场景描述生成
  - 实现NPC对话生成
  - 实现混沌效应决策
  - 实现事件叙述
  - 实现结果描述
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 19.1 编写AI服务单元测试
  - 测试场景描述生成
  - 测试NPC对话生成
  - 测试混沌效应选择
  - 测试错误处理

- [x] 20. 实现游戏流程控制
  - 实现晨会阶段逻辑
  - 实现调查阶段逻辑
  - 实现遭遇阶段逻辑
  - 实现余波阶段逻辑
  - 实现阶段转换控制
  - _需求: 3.1, 3.2, 3.3, 3.5_

- [x] 20.1 编写游戏流程单元测试
  - 测试晨会阶段
  - 测试调查阶段
  - 测试遭遇阶段
  - 测试阶段转换

## 阶段10: 存档系统

- [ ] 21. 实现存档服务
  - 创建SaveService接口和实现
  - 实现游戏状态序列化
  - 实现游戏状态反序列化
  - 实现存档CRUD操作
  - 实现版本兼容性检查
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 21.1 编写存档round-trip属性测试
  - **属性15: 存档round-trip**
  - **验证需求: 11.1, 11.2**

- [x] 21.2 编写存档服务单元测试
  - 测试存档保存
  - 测试存档加载
  - 测试存档列表
  - 测试存档删除
  - 测试错误处理

## 阶段11: 数据访问层

- [ ] 22. 实现角色仓储
  - 创建AgentRepository接口和实现
  - 实现PostgreSQL数据访问
  - 实现Redis缓存
  - 实现事务支持
  - _需求: 1.5, 16.4_

- [x] 22.1 编写角色仓储单元测试
  - 测试CRUD操作
  - 测试缓存行为
  - 测试事务回滚

- [ ] 23. 实现会话仓储
  - 创建SessionRepository接口和实现
  - 实现PostgreSQL数据访问
  - 实现Redis缓存
  - 实现并发控制
  - _需求: 11.2, 16.4_

- [x] 23.1 编写会话仓储单元测试
  - 测试CRUD操作
  - 测试缓存行为
  - 测试并发访问

- [ ] 24. 实现存档仓储
  - 创建SaveRepository接口和实现
  - 实现PostgreSQL数据访问
  - 实现存档查询
  - _需求: 11.1, 11.4_

- [x] 24.1 编写存档仓储单元测试
  - 测试CRUD操作
  - 测试查询功能

## 阶段12: API层

- [ ] 25. 实现角色API控制器
  - 创建AgentController
  - 实现POST /api/agents（创建角色）
  - 实现GET /api/agents/:id（获取角色）
  - 实现PUT /api/agents/:id（更新角色）
  - 实现DELETE /api/agents/:id（删除角色）
  - 实现请求验证和错误处理
  - _需求: 16.1, 16.2, 16.3_

- [ ] 25.1 编写角色API集成测试
  - 测试角色创建流程
  - 测试角色查询
  - 测试角色更新
  - 测试错误响应

- [ ] 26. 实现游戏会话API控制器
  - 创建SessionController
  - 实现POST /api/sessions（创建会话）
  - 实现GET /api/sessions/:id（获取会话）
  - 实现POST /api/sessions/:id/actions（执行行动）
  - 实现POST /api/sessions/:id/phase（转换阶段）
  - 实现请求验证和错误处理
  - _需求: 16.1, 16.2, 16.3_

- [ ] 26.1 编写会话API集成测试
  - 测试会话创建
  - 测试行动执行
  - 测试阶段转换
  - 测试错误响应

- [ ] 27. 实现骰子API控制器
  - 创建DiceController
  - 实现POST /api/dice/roll（掷骰）
  - 实现POST /api/dice/ability（能力掷骰）
  - 实现POST /api/dice/request（请求机构掷骰）
  - 实现请求验证和错误处理
  - _需求: 16.1, 16.2, 16.3_

- [ ] 27.1 编写骰子API集成测试
  - 测试基础掷骰
  - 测试能力掷骰
  - 测试请求机构掷骰
  - 测试错误响应

- [ ] 28. 实现剧本API控制器
  - 创建ScenarioController
  - 实现GET /api/scenarios（列出剧本）
  - 实现GET /api/scenarios/:id（获取剧本）
  - 实现GET /api/scenarios/:id/scenes/:sceneId（获取场景）
  - 实现请求验证和错误处理
  - _需求: 16.1, 16.2, 16.3_

- [ ] 28.1 编写剧本API集成测试
  - 测试剧本列表
  - 测试剧本详情
  - 测试场景获取
  - 测试错误响应

- [ ] 29. 实现存档API控制器
  - 创建SaveController
  - 实现POST /api/saves（保存游戏）
  - 实现GET /api/saves（列出存档）
  - 实现GET /api/saves/:id（获取存档）
  - 实现POST /api/saves/:id/load（加载存档）
  - 实现DELETE /api/saves/:id（删除存档）
  - 实现请求验证和错误处理
  - _需求: 16.1, 16.2, 16.3_

- [ ] 29.1 编写存档API集成测试
  - 测试存档保存
  - 测试存档列表
  - 测试存档加载
  - 测试存档删除
  - 测试错误响应

## 阶段13: 中间件和基础设施

- [ ] 30. 实现认证中间件
  - 创建JWT认证中间件
  - 实现token验证
  - 实现用户身份提取
  - _需求: 16.1_

- [ ] 30.1 编写认证中间件单元测试
  - 测试有效token
  - 测试无效token
  - 测试缺失token

- [ ] 31. 实现日志中间件
  - 创建请求日志中间件
  - 实现请求/响应记录
  - 实现性能追踪
  - _需求: 16.2_

- [ ] 32. 实现错误处理中间件
  - 创建全局错误处理器
  - 实现错误响应标准化
  - 实现错误日志记录
  - _需求: 16.3_

- [ ] 32.1 编写错误处理单元测试
  - 测试各种错误类型
  - 测试错误响应格式
  - 测试日志记录

- [ ] 33. 实现速率限制中间件
  - 创建速率限制中间件
  - 实现基于IP的限流
  - 实现基于用户的限流
  - _需求: 16.1_

- [ ] 33.1 编写速率限制单元测试
  - 测试限流触发
  - 测试限流重置
  - 测试不同端点的限制

## 阶段14: 剧本数据和配置

- [x] 34. 创建永恒之泉剧本数据
  - 创建剧本JSON文件
  - 定义异常体档案（永恒之泉）
  - 定义所有场景和地点
  - 定义NPC和对话
  - 定义线索和事件
  - 定义混沌效应
  - _需求: 12.1, 12.2_

- [x] 34.1 验证剧本数据完整性
  - 测试剧本加载
  - 验证所有引用的有效性
  - 验证场景连接

- [ ] 35. 创建ARC系统配置数据
  - 创建9种异常体配置JSON
  - 创建9种现实配置JSON
  - 创建9种职能配置JSON
  - 定义所有异常能力
  - _需求: 1.1, 1.2, 1.3, 7.1_

- [ ] 35.1 验证ARC配置完整性
  - 测试配置加载
  - 验证所有能力定义
  - 验证资质分配

- [ ] 36. 创建应用配置
  - 创建config.yaml配置文件
  - 配置数据库连接
  - 配置Redis连接
  - 配置AI服务
  - 配置日志级别
  - 配置速率限制
  - _需求: 16.1, 16.2_

## 阶段15: 文档和部署

- [ ] 37. 生成API文档
  - 创建OpenAPI/Swagger规范
  - 添加API端点文档
  - 添加请求/响应示例
  - 配置Swagger UI
  - _需求: 16.5_

- [ ] 38. 创建部署配置
  - 完善Dockerfile
  - 创建docker-compose.yml
  - 创建Kubernetes部署配置
  - 创建环境变量模板
  - _需求: 16.1_

- [ ] 39. 编写README和使用文档
  - 创建项目README
  - 编写快速开始指南
  - 编写API使用示例
  - 编写开发指南
  - 编写部署指南

## 阶段16: 最终检查点

- [ ] 40. 最终集成测试和验证
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行所有集成测试
  - 验证所有18个正确性属性
  - 执行端到端游戏流程测试
  - 确保所有测试通过，如有问题请询问用户
