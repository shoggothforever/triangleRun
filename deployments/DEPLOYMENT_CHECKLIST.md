# 生产环境部署检查清单

在将三角机构TRPG单人引擎部署到生产环境之前，请完成以下检查清单。

## 📋 部署前检查

### 1. 环境配置

- [ ] 已复制 `.env.example` 为 `.env`
- [ ] 已更新所有环境变量为生产值
- [ ] `SERVER_MODE=release`
- [ ] `LOG_LEVEL=info` 或 `warn`
- [ ] `ENABLE_AUTH=true`
- [ ] `ENABLE_SWAGGER=false`（或限制访问）
- [ ] `ENABLE_PPROF=false`

### 2. 安全配置

- [ ] 数据库密码已更新为强密码（至少16位，包含大小写字母、数字、特殊字符）
- [ ] Redis密码已设置
- [ ] JWT密钥已更新为强随机密钥（使用 `openssl rand -base64 32` 生成）
- [ ] AI API密钥已正确配置
- [ ] CORS源已限制为具体域名
- [ ] 数据库SSL模式已启用（如果支持）
- [ ] 所有默认密码已更改

### 3. 网络配置

- [ ] 域名已正确配置
- [ ] DNS记录已设置
- [ ] SSL证书已准备（Let's Encrypt或其他）
- [ ] 防火墙规则已配置
- [ ] 只暴露必要端口（80, 443）
- [ ] 数据库和Redis不对外暴露

### 4. 资源配置

- [ ] 服务器资源满足最低要求（4核CPU，8GB内存）
- [ ] 磁盘空间充足（至少50GB）
- [ ] 数据库存储已规划
- [ ] 备份存储已准备
- [ ] 监控存储已准备

### 5. 数据库配置

- [ ] PostgreSQL版本 >= 15
- [ ] 数据库已创建
- [ ] 数据库用户已创建并授权
- [ ] 连接池参数已优化
- [ ] 慢查询日志已启用
- [ ] 自动备份已配置

### 6. 缓存配置

- [ ] Redis版本 >= 7
- [ ] Redis持久化已启用（AOF）
- [ ] 最大内存策略已设置
- [ ] Redis密码已设置

### 7. 监控和日志

- [ ] Prometheus已配置（如果使用）
- [ ] Grafana已配置（如果使用）
- [ ] 日志聚合已配置
- [ ] 告警规则已设置
- [ ] 健康检查端点可访问

### 8. 备份策略

- [ ] 数据库自动备份已配置
- [ ] 备份保留策略已定义
- [ ] 备份恢复流程已测试
- [ ] 配置文件已备份
- [ ] 密钥已安全存储

## 🚀 部署步骤

### Docker Compose部署

- [ ] 已拉取最新代码
- [ ] 已构建Docker镜像
- [ ] 已测试镜像
- [ ] 已执行部署脚本
- [ ] 服务已启动
- [ ] 健康检查通过

### Kubernetes部署

- [ ] 已更新所有YAML文件
- [ ] Secrets已正确配置
- [ ] ConfigMaps已更新
- [ ] 镜像已推送到仓库
- [ ] 已创建命名空间
- [ ] 已部署数据库
- [ ] 已部署Redis
- [ ] 已部署后端服务
- [ ] Ingress已配置
- [ ] HPA已配置
- [ ] 所有Pod运行正常

## ✅ 部署后验证

### 1. 服务可用性

- [ ] 健康检查端点返回200: `curl http://your-domain/health`
- [ ] API端点可访问
- [ ] Swagger文档可访问（如果启用）
- [ ] 数据库连接正常
- [ ] Redis连接正常

### 2. 功能测试

- [ ] 可以创建角色
- [ ] 可以创建游戏会话
- [ ] 可以执行掷骰
- [ ] 可以保存游戏
- [ ] 可以加载游戏
- [ ] AI服务正常工作

### 3. 性能测试

- [ ] 响应时间在可接受范围内（< 200ms）
- [ ] 并发请求处理正常
- [ ] 内存使用正常
- [ ] CPU使用正常
- [ ] 数据库查询性能正常

### 4. 安全测试

- [ ] 未授权访问被拒绝
- [ ] SQL注入防护有效
- [ ] XSS防护有效
- [ ] CSRF防护有效
- [ ] 速率限制生效
- [ ] HTTPS强制重定向生效

### 5. 监控验证

- [ ] Prometheus指标可访问
- [ ] Grafana仪表板显示正常
- [ ] 日志正常输出
- [ ] 告警规则生效
- [ ] 错误追踪正常

## 📊 性能基准

记录部署后的性能基准，用于后续监控：

```
日期: ___________
环境: ___________

响应时间:
- 健康检查: _____ ms
- 创建角色: _____ ms
- 掷骰: _____ ms
- 保存游戏: _____ ms

资源使用:
- CPU使用率: _____ %
- 内存使用: _____ MB
- 数据库连接数: _____
- Redis内存: _____ MB

并发能力:
- 最大并发用户: _____
- 每秒请求数: _____
```

## 🔄 回滚计划

如果部署出现问题，执行以下回滚步骤：

### Docker Compose回滚

```bash
# 1. 停止当前服务
docker-compose down

# 2. 切换到上一个版本
git checkout <previous-version>

# 3. 恢复数据库（如果需要）
docker-compose exec -T postgres psql -U trpg trpg_solo_engine < backup.sql

# 4. 重新启动
docker-compose up -d
```

### Kubernetes回滚

```bash
# 查看部署历史
kubectl rollout history deployment/trpg-backend -n trpg-solo-engine

# 回滚到上一个版本
kubectl rollout undo deployment/trpg-backend -n trpg-solo-engine

# 回滚到特定版本
kubectl rollout undo deployment/trpg-backend --to-revision=<revision> -n trpg-solo-engine
```

## 📞 紧急联系

记录关键人员联系方式：

```
技术负责人: ___________
运维负责人: ___________
数据库管理员: ___________
紧急联系电话: ___________
```

## 📝 部署记录

```
部署日期: ___________
部署人员: ___________
版本号: ___________
Git Commit: ___________
部署环境: ___________
部署方式: ___________

遇到的问题:
___________________________________________
___________________________________________

解决方案:
___________________________________________
___________________________________________

备注:
___________________________________________
___________________________________________
```

## ✨ 部署完成

- [ ] 所有检查项已完成
- [ ] 所有测试已通过
- [ ] 性能基准已记录
- [ ] 回滚计划已准备
- [ ] 团队已通知
- [ ] 文档已更新
- [ ] 监控已启用
- [ ] 备份已验证

**恭喜！生产环境部署完成！** 🎉

记得定期检查监控指标，及时处理告警，保持系统健康运行。
